import os
import discord
import asyncio
import requests
from discord.ext import commands
from discord.ui import Modal, TextInput, Button, View, Select

from myserver import server_on

TOKEN = os.getenv("TOKEN")
WEBHOOK_URL = os.getenv("WEBHOOK_URL")

intents = discord.Intents.default()
intents.message_content = True
intents.members = True
bot = commands.Bot(command_prefix="!", intents=intents)

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ guild_settings
guild_settings = {}

class MessageModal(Modal):
    def __init__(self, selected_user):
        super().__init__(title="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°")
        self.selected_user = selected_user
        self.add_item(TextInput(label="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"))

    async def callback(self, interaction: discord.Interaction):
        try:
            content = self.children[0].value
            final_message = f"{content}\n\n‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢: ‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°"
            announce_channel = bot.get_channel(guild_settings[interaction.guild.id]['announce_channel_id'])
            if announce_channel:
                await announce_channel.send(f"{self.selected_user.mention}\n{final_message}", allowed_mentions=discord.AllowedMentions(users=True, roles=True, everyone=False))
                await interaction.response.send_message(f"‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á: {self.selected_user.display_name}", ephemeral=True)
            else:
                await interaction.response.send_message("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", ephemeral=True)
        except Exception as e:
            print(f"[ERROR] Error in MessageModal callback: {e}")
            await interaction.response.send_message(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}", ephemeral=True)

class SelectUserView(View):
    def __init__(self, members, page=0):
        super().__init__()
        self.page = page
        self.members = members
        self.per_page = 25
        self.max_pages = (len(members) - 1) // self.per_page + 1
        self.update_select_menu()
        self.update_buttons()

    def update_select_menu(self):
        start = self.page * self.per_page
        end = start + self.per_page
        self.clear_items()
        if len(self.members[start:end]) < 1:
            self.add_item(SelectUser(self.members[start:end], disabled=True))
        else:
            self.add_item(SelectUser(self.members[start:end]))

    def update_buttons(self):
        if self.page > 0:
            self.add_item(PreviousPageButton())
        if self.page < self.max_pages - 1:
            self.add_item(NextPageButton())

class SelectUser(Select):
    def __init__(self, members, placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1 ‡∏Ñ‡∏ô)", disabled=False):
        options = [discord.SelectOption(label=member.display_name, value=str(member.id)) for member in members]
        super().__init__(placeholder=placeholder, min_values=1, max_values=1, options=options, disabled=disabled)

    async def callback(self, interaction: discord.Interaction):
        if self.disabled:
            await interaction.response.send_message("‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", ephemeral=True)
            return
        try:
            selected_user = interaction.guild.get_member(int(self.values[0]))
            modal = MessageModal(selected_user)
            await interaction.response.send_modal(modal)
        except Exception as e:
            print(f"[ERROR] Error in SelectUser callback: {e}")
            await interaction.response.send_message(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}", ephemeral=True)

class PreviousPageButton(Button):
    def __init__(self):
        super().__init__(style=discord.ButtonStyle.primary, label="‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤")

    async def callback(self, interaction: discord.Interaction):
        view: SelectUserView = self.view
        view.page -= 1
        view.update_select_menu()
        view.update_buttons()
        await interaction.response.edit_message(view=view)

class NextPageButton(Button):
    def __init__():
        super().__init__(style=discord.ButtonStyle.primary, label="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ")

    async def callback(self, interaction: discord.Interaction):
        view: SelectUserView = self.view
        view.page += 1
        view.update_select_menu()
        view.update_buttons()
        await interaction.response.edit_message(view=view)

class StartMessageButton(Button):
    def __init__(self):
        super().__init__(style=discord.ButtonStyle.primary, label="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°")

    async def callback(self, interaction: discord.Interaction):
        members = interaction.guild.members
        if len(members) < 1:
            await interaction.response.send_message("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", ephemeral=True)
            return
        view = SelectUserView(members)
        await interaction.response.send_message("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:", view=view, ephemeral=True)

@bot.tree.command(name="help", description="‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏ó‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ")
async def help_command(interaction: discord.Interaction):
    embed = discord.Embed(
        title="‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏ó",
        description="‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó‡∏ô‡∏µ‡πâ:",
        color=discord.Color.green()
    )
    embed.add_field(name="/setup", value="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏° ‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö", inline=False)
    embed.add_field(name="/help", value="‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏ó‡∏ô‡∏µ‡πâ", inline=False)
    embed.set_footer(text="‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö")

    await interaction.response.send_message(embed=embed, ephemeral=True)

async def log_message(content):
    print(f"[LOG] {content}")
    if WEBHOOK_URL:
        try:
            print(f"[DEBUG] Sending log to webhook: {WEBHOOK_URL}")
            response = requests.post(WEBHOOK_URL, json={"content": content})
            if response.status_code != 204:
                print(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á webhook ‡πÑ‡∏î‡πâ: {response.status_code} - {response.text}")
        except Exception as e:
            print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á webhook: {e}")
    else:
        print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö URL ‡∏Ç‡∏≠‡∏á webhook")

@bot.event
async def on_ready():
    if not getattr(bot, 'synced', False):
        await bot.tree.sync()
        bot.synced = True
        print(f'‚úÖ ‡∏ö‡∏≠‡∏ó‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: {bot.user}')
        await log_message("‚úÖ ‡∏ö‡∏≠‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")

@bot.tree.command(name="setup", description="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°")
async def setup(interaction: discord.Interaction):
    if not interaction.user.guild_permissions.administrator:
        await interaction.response.send_message("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ", ephemeral=True)
        await log_message(f"‚ö†Ô∏è ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ {interaction.user} ({interaction.user.id}) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á setup ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå")
        return

    guild_id = interaction.guild.id

    category = await interaction.guild.create_category("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°")
    input_channel = await category.create_text_channel("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°")
    announce_channel = await category.create_text_channel("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°")

    guild_settings[guild_id] = {
        'input_channel_id': input_channel.id,
        'announce_channel_id': announce_channel.id
    }

    embed = discord.Embed(
        title="üì© ‡πÉ‡∏´‡πâ‡∏û‡∏£‡∏µ‡πà‡πÇ‡∏ï‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏∏‡∏ì",
        description="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°",
        color=discord.Color.blue()
    )

    view = View()
    view.add_item(StartMessageButton())

    await input_channel.send(embed=embed, view=view)
    await interaction.response.send_message("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö setup ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n(‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)", ephemeral=True)
    await log_message(f"‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö setup ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: {interaction.guild.name} ‡πÇ‡∏î‡∏¢ {interaction.user} ({interaction.user.id})")

server_on()
bot.run(TOKEN)
